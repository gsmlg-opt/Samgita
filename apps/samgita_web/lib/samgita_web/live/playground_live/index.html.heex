<div
  class="max-w-7xl mx-auto px-4 py-8"
  id="playground-container"
  phx-hook="PlaygroundPersistence"
>
  <div class="mb-8">
    <h1 class="text-3xl font-bold text-zinc-900">Agent Playground</h1>
    <p class="text-zinc-600 mt-2">
      Interact with ClaudeAgent in real-time. Choose an agent type and start chatting.
    </p>
  </div>
  
<!-- API Key Notice -->
  <div class="mb-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
    <div class="flex items-start gap-3">
      <svg
        class="w-5 h-5 text-blue-600 mt-0.5"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
        />
      </svg>
      <div class="flex-1">
        <h3 class="font-semibold text-blue-900 text-sm">Authentication Required</h3>
        <p class="text-sm text-blue-800 mt-1">
          Set either <code class="bg-blue-100 px-1 py-0.5 rounded">CLAUDE_CODE_OAUTH_TOKEN</code>
          or <code class="bg-blue-100 px-1 py-0.5 rounded">ANTHROPIC_API_KEY</code>
          to use the playground.
          Get your API key from
          <a
            href="https://console.anthropic.com/"
            target="_blank"
            class="underline hover:text-blue-600"
          >
            console.anthropic.com
          </a>
        </p>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
    <!-- Conversations Sidebar -->
    <div class="lg:col-span-1">
      <div class="bg-white rounded-lg shadow-lg border border-zinc-200 p-4">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold text-zinc-900">Conversations</h2>
          <button
            phx-click="new_conversation"
            phx-value-type={get_current_conversation(assigns).agent_type}
            class="p-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors"
            title="New conversation"
          >
            <.icon name="hero-plus" class="w-4 h-4" />
          </button>
        </div>

        <div class="space-y-2 max-h-[600px] overflow-y-auto">
          <%= for conv <- Enum.reverse(@conversations) do %>
            <div
              phx-click={JS.push("select_conversation", value: %{id: conv.id})}
              class={[
                "group relative px-3 py-2 rounded-lg cursor-pointer transition-colors",
                if(@current_conversation_id == conv.id,
                  do: "bg-blue-50 border-2 border-blue-500",
                  else: "bg-zinc-50 border-2 border-transparent hover:bg-zinc-100"
                )
              ]}
            >
              <div class="flex items-start justify-between gap-2">
                <div class="flex-1 min-w-0">
                  <p class={[
                    "text-sm font-medium truncate",
                    if(@current_conversation_id == conv.id,
                      do: "text-blue-700",
                      else: "text-zinc-700"
                    )
                  ]}>
                    {get_conversation_title(conv)}
                  </p>
                  <p class="text-xs text-zinc-500 mt-1">
                    {format_timestamp(conv.created_at)} Â· {length(conv.messages)} msgs
                  </p>
                </div>
                <%= if length(@conversations) > 1 do %>
                  <div phx-click="noop" class="flex-shrink-0">
                    <button
                      phx-click="delete_conversation"
                      phx-value-id={conv.id}
                      class="opacity-0 group-hover:opacity-100 p-1 hover:bg-red-100 rounded transition-opacity"
                      title="Delete conversation"
                    >
                      <.icon name="hero-trash" class="w-3 h-3 text-red-600" />
                    </button>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
    
<!-- Agent Type Selection -->
    <div class="lg:col-span-1">
      <div class="bg-white rounded-lg shadow-lg border border-zinc-200 p-6">
        <h2 class="text-lg font-semibold text-zinc-900 mb-4">Agent Type</h2>
        <div class="space-y-2">
          <%= for type <- [
            %{value: "coding-assistant", label: "Coding Assistant", icon: "code-bracket"},
            %{value: "file-manager", label: "File Manager", icon: "folder"},
            %{value: "code-reviewer", label: "Code Reviewer", icon: "eye"},
            %{value: "test-generator", label: "Test Generator", icon: "beaker"}
          ] do %>
            <button
              phx-click="select_agent_type"
              phx-value-type={type.value}
              class={[
                "w-full flex items-center gap-3 px-4 py-3 rounded-lg text-left transition-colors",
                if(get_current_conversation(assigns).agent_type == type.value,
                  do: "bg-blue-50 border-2 border-blue-500 text-blue-700",
                  else: "bg-zinc-50 border-2 border-transparent hover:bg-zinc-100 text-zinc-700"
                )
              ]}
            >
              <.icon name={"hero-#{type.icon}"} class="w-5 h-5" />
              <span class="font-medium text-sm">{type.label}</span>
            </button>
          <% end %>
        </div>

        <div class="mt-6 pt-6 border-t border-zinc-200">
          <h3 class="text-sm font-semibold text-zinc-700 mb-2">Available Tools</h3>
          <div class="space-y-1 text-xs text-zinc-600">
            <%= for tool <- ["read_file", "write_file", "edit_file", "bash", "glob", "grep"] do %>
              <div class="flex items-center gap-2">
                <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                <span>{tool}</span>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
    
<!-- Main Chat Area -->
    <div class="lg:col-span-3">
      <div class="bg-white rounded-lg shadow-lg border border-zinc-200 flex flex-col h-[700px]">
        <!-- Chat Messages -->
        <div class="flex-1 overflow-y-auto p-6 space-y-4" id="chat-messages">
          <% current_conversation = get_current_conversation(assigns) %>
          <%= if current_conversation.messages == [] do %>
            <div class="flex items-center justify-center h-full text-zinc-400">
              <div class="text-center">
                <.icon
                  name="hero-chat-bubble-left-right"
                  class="w-16 h-16 mx-auto mb-4 opacity-50"
                />
                <p class="text-lg font-medium">Start a conversation</p>
                <p class="text-sm mt-2">
                  Select an agent type and send a message to get started
                </p>
              </div>
            </div>
          <% else %>
            <%= for message <- current_conversation.messages do %>
              <%= if message.role == "user" do %>
                <div class="flex justify-end">
                  <div class="max-w-[80%] bg-blue-500 text-white rounded-lg px-4 py-3">
                    <p class="text-sm whitespace-pre-wrap">{message.content}</p>
                  </div>
                </div>
              <% else %>
                <div class="flex justify-start">
                  <div class="max-w-[80%] bg-zinc-100 text-zinc-900 rounded-lg px-4 py-3">
                    <div class="flex items-center gap-2 mb-2">
                      <.icon name="hero-cpu-chip" class="w-4 h-4 text-blue-600" />
                      <span class="text-xs font-semibold text-blue-600">Agent</span>
                    </div>
                    <div class="prose prose-sm prose-zinc max-w-none">
                      <el-dm-markdown>{message.content}</el-dm-markdown>
                    </div>
                  </div>
                </div>
              <% end %>
            <% end %>
          <% end %>

          <%= if @loading do %>
            <div class="flex justify-start">
              <div class="max-w-[80%] bg-zinc-100 text-zinc-900 rounded-lg px-4 py-3">
                <div class="flex items-center gap-2">
                  <.icon name="hero-cpu-chip" class="w-4 h-4 text-blue-600 animate-pulse" />
                  <span class="text-xs font-semibold text-blue-600">Agent is thinking...</span>
                </div>
                <div class="flex gap-1 mt-2">
                  <span class="w-2 h-2 bg-blue-400 rounded-full animate-bounce"></span>
                  <span
                    class="w-2 h-2 bg-blue-400 rounded-full animate-bounce"
                    style="animation-delay: 0.1s"
                  >
                  </span>
                  <span
                    class="w-2 h-2 bg-blue-400 rounded-full animate-bounce"
                    style="animation-delay: 0.2s"
                  >
                  </span>
                </div>
              </div>
            </div>
          <% end %>

          <%= if current_conversation.error do %>
            <div class="flex justify-center">
              <div class="bg-red-50 border border-red-200 text-red-700 rounded-lg px-4 py-3 max-w-[80%]">
                <div class="flex items-center gap-2 mb-1">
                  <.icon name="hero-exclamation-triangle" class="w-4 h-4" />
                  <span class="font-semibold text-sm">Error</span>
                </div>
                <p class="text-sm">{current_conversation.error}</p>
              </div>
            </div>
          <% end %>
        </div>
        
<!-- Input Area -->
        <div class="border-t border-zinc-200 p-4">
          <form phx-submit="send_message" class="flex gap-2">
            <input
              type="text"
              name="message"
              value={@input}
              phx-change="update_input"
              placeholder="Type your message... (e.g., 'List all .ex files in lib/')"
              class="flex-1 px-4 py-2 border border-zinc-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              disabled={@loading}
              autofocus
            />
            <button
              type="submit"
              disabled={@loading || @input == ""}
              class="px-6 py-2 bg-blue-500 hover:bg-blue-600 disabled:bg-zinc-300 text-white font-medium rounded-lg transition-colors"
            >
              <%= if @loading do %>
                <.icon name="hero-arrow-path" class="w-5 h-5 animate-spin" />
              <% else %>
                <.icon name="hero-paper-airplane" class="w-5 h-5" />
              <% end %>
            </button>
          </form>
          <p class="text-xs text-zinc-500 mt-2">
            ðŸ’¡ Try: "Read mix.exs", "Find all LiveView files", "What dependencies are installed?"
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // LiveView hooks for persistence
  window.PlaygroundHooks = window.PlaygroundHooks || {};

  window.PlaygroundHooks.PlaygroundPersistence = {
    mounted() {
      // Load conversations from localStorage on mount
      const stored = localStorage.getItem('playground_conversations');
      const currentId = localStorage.getItem('playground_current_id');

      if (stored && currentId) {
        try {
          const data = JSON.parse(stored);
          this.pushEvent('restore_conversations', {
            conversations: data,
            current_id: currentId
          });
        } catch (e) {
          console.error('Failed to restore conversations:', e);
        }
      }

      // Listen for save events from server
      this.handleEvent('save_conversations', ({ conversations, current_id }) => {
        localStorage.setItem('playground_conversations', JSON.stringify(conversations));
        localStorage.setItem('playground_current_id', current_id);
      });
    }
  };

  // Auto-scroll chat to bottom
  const chatMessages = document.getElementById('chat-messages');
  if (chatMessages) {
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }
</script>
